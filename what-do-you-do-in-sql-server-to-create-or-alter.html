<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="RiffDash"><meta property="og:type" content="article"><meta name=robots content="index,follow,noarchive"><meta property="og:image" content="//img/home-bg-jeep.jpg"><meta property="twitter:image" content="//img/home-bg-jeep.jpg"><meta name=title content="What do you do in SQL Server to CREATE OR ALTER?"><meta property="og:title" content="What do you do in SQL Server to CREATE OR ALTER?"><meta property="twitter:title" content="What do you do in SQL Server to CREATE OR ALTER?"><meta name=description content="The year is 2009 and SQL Server does not have CREATE OR ALTER/REPLACE. This is what I do instead. For triggers, you have to lean on the proprietary system views. Is this the most accepted convention in the meantime?"><meta property="og:description" content="The year is 2009 and SQL Server does not have CREATE OR ALTER/REPLACE. This is what I do instead. For triggers, you have to lean on the proprietary system views. Is this the most accepted convention in the meantime?"><meta property="twitter:description" content="The year is 2009 and SQL Server does not have CREATE OR ALTER/REPLACE. This is what I do instead. For triggers, you have to lean on the proprietary system views. Is this the most accepted convention in the meantime?"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=./img/favicon.ico><title>What do you do in SQL Server to CREATE OR ALTER? |</title><link rel=canonical href=./what-do-you-do-in-sql-server-to-create-or-alter.html><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cleanwhite/css/bootstrap.min.css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cleanwhite/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cleanwhite/css/zanshang.css><link href=https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css rel=stylesheet type=text/css><script src=https://assets.cdnweb.info/hugo/cleanwhite/js/jquery.min.js></script>
<script src=https://assets.cdnweb.info/hugo/cleanwhite/js/bootstrap.min.js></script>
<script src=https://assets.cdnweb.info/hugo/cleanwhite/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=./>RiffDash</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=./categories/blog>blog</a></li><li><a href=./sitemap.xml>Sitemap</a></li><li><a href=./index.xml>RSS</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home-bg-jeep.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags></div><h1>What do you do in SQL Server to CREATE OR ALTER?</h1><h2 class=subheading></h2><span class=meta>Posted by
Jenniffer Sheldon
on
Friday, May 24, 2024</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>The year is 2009 and SQL Server does not have CREATE OR ALTER/REPLACE. This is what I do instead.</p><pre><code>IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_NAME = 'SynchronizeRemoteCatalog' AND ROUTINE_SCHEMA = 'dbo' AND ROUTINE_TYPE = 'PROCEDURE') EXEC ('DROP PROCEDURE dbo.SynchronizeRemoteCatalog') CREATE PROCEDURE dbo.SynchronizeRemoteCatalog AS BEGIN -- body END </code></pre><p>For triggers, you have to lean on the proprietary system views.</p><p>Is this the most accepted convention in the meantime?</p><p><strong>EDIT:</strong> As n8wrl suggested, the <a href=# rel=noreferrer>official word</a> suggests that this feature is not a high priority. Hence the question.</p><span class=d-none itemprop=commentCount>3</span><h2 class=mb0 data-answercount=14>14 Answers</h2><p>This article makes a good point about losing permissions when dropping an object in SQL server.</p><ul><li><a href=# rel=noreferrer>Tips ‘N’ Tricks – T-SQL – An Elegant way to CREATE or ALTER Stored Procedures in One-Go for Easy Maintenance</a></li></ul><p>So here is the approach which retains permissions:</p><pre><code>IF OBJECT_ID('spCallSomething') IS NULL EXEC('CREATE PROCEDURE spCallSomething AS SET NOCOUNT ON;') GO ALTER PROCEDURE spCallSomething ... --instead of DROP/CREATE </code></pre><p>Also works for functions, just replace <code>PROCEDURE</code> with <code>FUNCTION</code> in the above code.</p><p>Another reason to consider doing it this way is tolerance to failure. Suppose your DROP succeeds, but your CREATE fails - you end with a broken DB. Using ALTER approach, you will end up with an older version of the object.</p><span class=d-none itemprop=commentCount>5</span><p>The year is 2009 and SQL Server does not have CREATE OR ALTER/REPLACE.</p><p>The year is 2016 and it does now have DIE (<a href=# rel=noreferrer>Drop If Exists</a>) in SQL Server 2016 RTM and <code>CREATE OR ALTER</code> (introduced in 2016 SP1).</p><p>Taking <code>Drop If Exists</code> first the caveats around needing to re-apply permissions with this approach still apply. Example syntax is</p><pre><code>DROP PROCEDURE IF EXISTS dbo.SynchronizeRemoteCatalog GO CREATE PROCEDURE dbo.SynchronizeRemoteCatalog AS BEGIN BODY: END GO /*TODO: Reapply permissions*/ </code></pre><p><code>CREATE OR ALTER</code> retains the permissions. Example syntax is</p><pre><code> CREATE OR ALTER PROCEDURE dbo.SynchronizeRemoteCatalog AS BEGIN BODY: END </code></pre><p>The <a href=# rel=noreferrer>corresponding MSSQL Tiger Team blog post</a> explains</p><p>CREATE OR ALTER can be used in programmability objects such as:</p><ul><li>STORED PROCEDURES (including natively compiled)</li><li>FUNCTIONS (Transact-SQL, including natively compiled)</li><li>TRIGGERS</li><li>VIEWS</li></ul><p>But cannot be used in:</p><ul><li>Objects that require storage (tables, indexes and indexed views)</li><li>CLR user-defined functions</li><li>Deprecated programmability objects (RULE and DEFAULT)</li><li>Non-programmability objects (such as CREATE ASSEMBLY, CREATE TABLE or CREATE - SCHEMA). On these objects, the syntax for CREATE and ALTER is very different from a syntax and usability perspective.</li></ul><span class=d-none itemprop=commentCount></span><p>We encountered a situation where we needed to update a remote site, but we didn’t have DROP permissions. Until now, we have been using the ‘DROP and CREATE’ script built into SSMS 2008 R2, but now we needed to change. We created three templates, which we drop above the appropriate ALTER scripts when we need to update a stored procedure or function:</p><pre><code>—- Stored Procedure IF OBJECT_ID('[dbo].[&lt;Name_Of_Routine, , &gt;]') IS NULL EXEC('CREATE PROCEDURE [dbo].[&lt;Name_Of_Routine, , &gt;] AS SET NOCOUNT ON;') EXEC('GRANT EXECUTE ON [&lt;Name_Of_Routine, , &gt;] TO Public AS dbo;') GO —- Scalar Function IF OBJECT_ID('[dbo].[&lt;Name_Of_Routine, , &gt;]') IS NULL EXEC('CREATE FUNCTION [dbo].[&lt;Name_Of_Routine, , &gt;] (@i INT) RETURNS INT AS BEGIN RETURN 0 END;') EXEC('GRANT EXECUTE ON [&lt;Name_Of_Routine, , &gt;] TO Public AS dbo;') GO —- Table-based Function IF OBJECT_ID('[dbo].[&lt;Name_Of_Routine, , &gt;]') IS NULL EXEC('CREATE FUNCTION [dbo].[&lt;Name_Of_Routine, , &gt;] (@i INT) RETURNS @O TABLE(i INT) AS BEGIN INSERT INTO @O SELECT 0 RETURN END;') GO </code></pre><p>Any special permissions get scripted after each CREATE (Table functions cannot be assigned permissions). After that, the ALTER doesn’t change it, and if they add or modify the permissions, they remain. Doing it this way, it’s an easy task to copy the name of the function or stored procedure, and use the Template Parameter replacement to automating the completion of these scriptlets.</p><p>Now, I’m hoping that the good folks at Microsoft will either add this to their “Script ___ as” lists, or give us the ability to create our own such that this scripting comes ‘baked-in’</p><p>You may want to throw some weight behind the SQL Server feedback entry at: <a href=# rel=nofollow>https://connect.microsoft.com/SQLServer/feedback/details/344991/create-or-alter-statement</a>. It seems to be one of the few that are still accessible publicly, and they state that they "have started a feasibility review for this to decide if we can ship this in the near future." The more voices, the more likely this will happen!</p><p>(Update: now also using the following code for Triggers and Views)</p><pre><code>-- Triggers IF OBJECT_ID('[dbo].[&lt;Name_Of_Trigger, , &gt;]') IS NULL -- Check if Trigger Exists EXEC('CREATE TRIGGER [dbo].[&lt;Name_Of_Trigger, , &gt;] ON [&lt;Name_Of_Table, , &gt;] AFTER UPDATE AS SET NOCOUNT ON;') -- Create dummy/empty SP GO -- Views IF OBJECT_ID('[dbo].[&lt;Name_Of_View, , &gt;]') IS NULL -- Check if View Exists EXEC('CREATE VIEW [dbo].[&lt;Name_Of_View, , &gt;] AS SELECT 1;') -- Create dummy/empty View GO </code></pre><span class=d-none itemprop=commentCount>0</span><p>Every time a developer writes <code>IF EXISTS(...) DROP</code> a seal pup is clubbed. You should know exactly what's in the database and your upgrade script should do the CREATE or ALTER as appropriate, based on the current version of your application schema: <a href=# rel="nofollow noreferrer">Version Control and your Database</a>.</p><span class=d-none itemprop=commentCount>8</span><p>I'd use <code>OBJECT_ID(...) IS NOT NULL</code> before a DROP.</p><p>Object identifiers have to be unique, so it works without using system tables:</p><pre><code>CREATE TRIGGER dbo.ExistingTable ON dbo.AnotherTable FOR UPDATE AS SET NOCOUNT ON GO </code></pre><p>gives</p><pre><code>Msg 2714, Level 16, State 2, Procedure MetaClass, Line 3 There is already an object named ExistingTable ' in the database. </code></pre><p>I normally use ALTER because of how we work with source control, etc.</p><span class=d-none itemprop=commentCount>3</span><p>I always <code>alter</code> my objects because a <code>drop</code> is really bad practice and can leave your DB in an bad state if an object fails to create (24/7 db!), as well as what the other posters have mentioned about nuking permissions.</p><p>Editors like Sublime, Atom, and VS Code will let you make code snippets as templates for these to quickly gen-up your skeleton script. SQL 2016 now finally supports <code>DROP IF EXISTS</code> construct, but it still approaches from the wrong direction - that everything is a <code>drop/create</code> instead of a one time <code>create</code> in the distant past and <code>alter</code> from then on. Also, I have tried to make my headers as short as will possibly work, so I don't get any fancier than <code>create proc dbo.myproc as</code> as the <code>create</code> stub.</p><p>Views:</p><pre><code>if objectproperty(object_id('dbo.myview'), 'IsView') is null begin exec('create view dbo.myview as select 1 c') end go alter view dbo.myview as -- select * -- from table go </code></pre><p>Procs:</p><pre><code>if objectproperty(object_id('dbo.myproc'), 'IsProcedure') is null begin exec('create proc dbo.myproc as') end go alter procedure dbo.myproc as set nocount on -- Add the stored proc contents here... go </code></pre><p>UDF (scalar):</p><pre><code>if objectproperty(object_id('dbo.myudf'), 'IsScalarFunction') is null begin exec('create function dbo.myudf returns int as begin return null end') end go alter function dbo.myudf(@s varchar(100)) returns int as begin -- return len(@s) end go </code></pre><p>UDF (tabular):</p><pre><code>if objectproperty(object_id('dbo.myudf'), 'IsTableFunction') is null begin exec('create function dbo.myudf returns @t table(x int) as begin return end') end go alter function dbo.myudf(@s varchar(100)) returns @result table ( -- Columns returned by the function id int identity(1, 1) primary key not null ,result varchar(100) null ) begin return end go </code></pre><span class=d-none itemprop=commentCount>1</span><p>That's basically the way to do it, yes. I just wonder if you have a particular reason to use the "EXEC" approach:</p><pre><code>IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_NAME = 'SynchronizeRemoteCatalog' AND ROUTINE_SCHEMA = 'dbo' AND ROUTINE_TYPE = 'PROCEDURE') EXEC ('DROP PROCEDURE dbo.SynchronizeRemoteCatalog') </code></pre><p>Why not just:</p><pre><code>IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_NAME = 'SynchronizeRemoteCatalog' AND ROUTINE_SCHEMA = 'dbo' AND ROUTINE_TYPE = 'PROCEDURE') DROP PROCEDURE dbo.SynchronizeRemoteCatalog </code></pre><p>???</p><p>For triggers, there's <code>sys.triggers</code>. Those are system catalog views in the "sys" schema - not strictly or directly tables, really.</p><p>Marc</p><span class=d-none itemprop=commentCount>1</span><p>The year is 2017 and SQL Server has CREATE OR ALTER</p><p>SQL Server 2016 SP1 and SQL Server vNext have new T-SQL language statement – <strong>CREATE [OR ALTER]</strong> for:</p><ul><li>STOREDPROCEDURES</li><li>FUNCTIONS</li><li>TRIGGERS</li><li>VIEWS</li></ul><p><a href=# rel="nofollow noreferrer">https://blogs.msdn.microsoft.com/sqlserverstorageengine/2016/11/17/create-or-alter-another-great-language-enhancement-in-sql-server-2016-sp1/</a></p><span class=d-none itemprop=commentCount>1</span><p>I prefer <code>CREATE-ALTER</code> approach (not syntax) over <code>DROP-CREATE</code> for two reasons:</p><ul><li>permissions (with <code>DROP-CREATE</code> you have to recreate them)</li><li>object_id (altering object won't change it)</li></ul><p><strong>Example <code>DROP-CREATE</code>:</strong></p><pre><code>--Initial creation: CREATE PROCEDURE dbo.my_proc AS SELECT * FROM dbo.a WHERE i &lt; 10; GO SELECT OBJECT_ID('dbo.my_proc'); GO -- Recreating DROP PROCEDURE IF EXISTS dbo.my_proc; GO CREATE PROCEDURE dbo.my_proc AS -- some meaningless comment SELECT * FROM dbo.a WHERE i &lt; 10; GO SELECT OBJECT_ID('dbo.my_proc'); GO </code></pre><p><strong><a href=# rel="nofollow noreferrer">DB Fiddle</a></strong></p><p>As we can see the <code>object_id</code> has changed.</p><p><strong>Example 2: <code>CREATE-ALTER</code></strong></p><pre><code>-- Initial creation CREATE PROCEDURE dbo.my_proc2 AS SELECT * FROM dbo.a WHERE i &lt; 10; GO SELECT OBJECT_ID('dbo.my_proc2'); GO -- Altering CREATE OR ALTER PROCEDURE dbo.my_proc2 AS -- some meaningless comment SELECT * FROM dbo.a WHERE i &lt; 10; GO SELECT OBJECT_ID('dbo.my_proc2'); GO </code></pre><p><strong><a href=# rel="nofollow noreferrer">DB Fiddle</a></strong></p><p>In this scenario the <code>object_id</code> remains the same.</p><p>Sample scenario when this can cause some problems. Let's assume that we use SQL Server 2016 Query Store and force to use specific query plan for stored procedure.</p><h1>DROP-CREATE</h1><pre><code>USE T1; GO -- make sure that Query Store is READ_WRITE IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[a]') AND type in (N'U')) BEGIN CREATE TABLE [dbo].[a]( [i] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY, [g] [uniqueidentifier] NULL, [z] VARCHAR(10) ); END GO -- populate table (15k records) INSERT INTO dbo.a(g, z) SELECT NEWID(), number FROM (SELECT CAST([key] AS INT) AS number FROM OPENJSON( '[1' + REPLICATE(',1',3000-1)+']') ) AS num GO 5 -- initial creation CREATE PROCEDURE dbo.my_proc AS SELECT * FROM dbo.a WHERE z LIKE '12%' AND 1 = (SELECT 1); GO -- Clustered Index Scan EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; GO --dc1 -- creating index CREATE NONCLUSTERED INDEX IX_dbo_a_z ON dbo.a([z] ASC) INCLUDE ([i], [g]); GO -- index seek EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; -- forcing plan GUI, clustered scan -- dc3 EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; -- dc4 -- Clustered Index Scan EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; -- dc5 /* MAIN PART - DROP - RECREATE */ DROP PROCEDURE IF EXISTS dbo.my_proc; GO CREATE PROCEDURE dbo.my_proc AS -- some meaningless comment added by developer SELECT * FROM dbo.a WHERE z LIKE '12%' AND 1 = (SELECT 1); GO /* MAIN PART END */ -- Index Seek EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; -- object_id in query store is NULL -- is_forced_plan flag is ignored !!! </code></pre><p>First execution:<br><a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/SI2Rc.png alt=DC1 style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>Adding index and execute: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/Q4B4P.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>Forcing plan: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/2z5AV.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a> <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/fkVU0.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>Another execution: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/aRQio.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>After <code>DROP-CREATE</code>: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/4V3tz.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><h1>CREATE - ALTER</h1><pre><code>USE T2; GO -- make sure that Query Store is READ_WRITE IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[a]') AND type in (N'U')) BEGIN CREATE TABLE [dbo].[a]( [i] [int] IDENTITY(1,1) NOT NULL PRIMARY KEY, [g] [uniqueidentifier] NULL, [z] VARCHAR(10) ); END GO -- populate table (15k records) INSERT INTO dbo.a(g, z) SELECT NEWID(), number FROM (SELECT CAST([key] AS INT) AS number FROM OPENJSON( '[1' + REPLICATE(',1',3000-1)+']') ) AS num GO 5 -- initial creation CREATE PROCEDURE dbo.my_proc AS SELECT * FROM dbo.a WHERE z LIKE '12%' AND 1 = (SELECT 1); GO -- Clustered Index Scan EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; -- ca1 GO -- creating index CREATE NONCLUSTERED INDEX IX_dbo_a_z ON dbo.a([z] ASC) INCLUDE ([i], [g]); GO -- index seek EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; --ca2 -- forcing plan GUI --ca3 EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; --ca4 -- Clustered Index Scan EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; --ca5 GO /* MAIN PART - CREATE-ALTER */ CREATE OR ALTER PROCEDURE dbo.my_proc AS -- some meaningless comment added by developer SELECT * FROM dbo.a WHERE z LIKE '12%' AND 1 = (SELECT 1); GO /* MAIN PART END */ -- Clustered Index Scan EXEC dbo.my_proc; EXEC sp_query_store_flush_db; SELECT qsq.query_id, qsq.query_text_id, qsq.context_settings_id, qsq.[object_id], OBJECT_NAME(qsq.[object_id]) AS [object_name], qsp.is_forced_plan, qsqt.query_sql_text, qsrs.count_executions, CAST(qsp.query_plan AS XbML) AS sql_query_plan FROM sys.query_store_query qsq JOIN sys.query_store_query_text qsqt ON qsq.query_text_id = qsqt.query_text_id JOIN sys.query_store_plan qsp ON qsq.query_id= qsp.query_id JOIN sys.query_store_runtime_stats qsrs ON qsrs.plan_id = qsp.plan_id WHERE query_sql_text LIKE '%dbo.a%' AND qsq.[object_id] &lt;&gt; 0 ORDER BY qsq.query_id; -- is_forced_plan is valid </code></pre><p>First execution:<br><a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/RDal4.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>Adding index and execute: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/WcOit.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>Forcing plan: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/YDwJN.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a> <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/ed7t2.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>Another execution: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/sKQC5.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><p>After <code>CREATE-ALTER</code>: <a href=# rel="nofollow noreferrer"><img src=https://cdn.statically.io/img/i.stack.imgur.com/xXkqr.png alt="enter image description here" style=margin:auto;display:block;text-align:center;max-width:100%;height:auto></a></p><h1>Result</h1><p>With Drop-Create we lost forced plan.</p><span class=d-none itemprop=commentCount></span><p>Looks like it's a while off: <a href=# rel="nofollow noreferrer">link text</a></p><p>typical script for me:</p><pre><code>IF EXISTS (SELECT name FROM sysobjects WHERE name = 'ig_InsertDealer' AND type = 'P') DROP PROC dbo.ig_InsertDealer GO CREATE PROCEDURE dbo.ig_InsertDealer ... GO GRANT EXECUTE ON dbo.ig_InsertDealer TO ... GO </code></pre><span class=d-none itemprop=commentCount>1</span><p>I'll use either depending on context: my initial-build or major refactoring scripts will use check/drop/create, pure maintenance scripts use alter.</p><span class=d-none itemprop=commentCount></span><p>I have a template, which allows to execute a script several times without errors.</p><pre><code>IF NOT EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[aaa_test]') AND type in (N'P', N'PC')) EXEC('CREATE PROCEDURE aaa_test AS') EXEC('GRANT EXECUTE ON aaa_test TO someone') GO ALTER PROCEDURE aaa_test @PAR1 INT, @PAR2 INT=0 AS BEGIN SELECT @PAR1 AS Par1, CASE @PAR2 WHEN 0 THEN 'Default' ELSE 'Other' END AS Par2 END GO </code></pre><p>Execution:</p><pre><code>EXEC aaa_test 1 EXEC aaa_test 1,5 </code></pre><span class=d-none itemprop=commentCount></span><p>You should not drop an object. Dropping an object suffers from two problems:</p><p>1) If the CREATE fails, you no longer have an object. (You can use transactions to avoid that, at the expense of a lot of boilerplate code)</p><p>2) You lose permissions on the object, if you do not explicitly re-create them.</p><p>I prefer to create a blank object within an "if not exists" condition, and then use ALTER, and have written helper procedures for that purpose.</p><span class=d-none itemprop=commentCount></span><p>Just to my <a href=#>extend previous answer</a>.</p><p>Another reason why I prefer <code>CREATE-ALTER</code> over <code>DROP-CREATE</code> approach. It could lead to losing specifc properties about object. For example <code>ExecIsStartup</code>:</p><pre><code>USE master GO CREATE TABLE dbo.silly_logging(id INT IDENTITY(1,1) PRIMARY KEY ,created_date DATETIME DEFAULT GETDATE() ,comment VARCHAR(100)); GO CREATE PROCEDURE dbo.my_procedure AS INSERT INTO dbo.silly_logging(comment) VALUES ('SQL Server Startup'); GO -- mark procedure to start at SQL Server instance startup EXEC sp_procoption @ProcName = 'dbo.my_procedure' , @OptionName = 'startup' , @OptionValue = 'on'; SELECT name, create_date, modify_date, is_auto_executed FROM master.sys.procedures WHERE is_auto_executed = 1; --name create_date modify_date is_auto_executed --my_procedure 2017-07-28 06:36:21.743 2017-07-28 06:36:24.513 1 </code></pre><p>Now let's assume that someone wants to update this procedure using <code>DROP-CREATE</code>:</p><pre><code>DROP PROCEDURE dbo.my_procedure; GO CREATE PROCEDURE dbo.my_procedure AS -- adding meaningless comment INSERT INTO dbo.silly_logging(comment) VALUES ('SQL Server Startup'); GO SELECT name, create_date, modify_date, is_auto_executed FROM master.sys.procedures WHERE is_auto_executed = 1; -- empty </code></pre><p>And if you are not aware of it or you don't check you will end up with procedure that won't start.</p><span class=d-none itemprop=commentCount></span><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmirpJawrLvVnqmfpJ%2Bse6S7zGiorp2jqbawutJoaG1rZGaDcXvWoZitZZSkerq71GabqGWZo3q0vctmqp6qppq%2FbsDOZpqrnZGpsm670WaYpayVpw%3D%3D</p><hr><ul class=pager><li class=previous><a href=./john-kelly-net-worth.html data-toggle=tooltip data-placement=top title="John Kelly Net Worth | Celebrity Net Worth">&larr;
Previous Post</a></li><li class=next><a href=./stephen-colletti-and-alex-weaver-are-engaged-after-1-year-of-dating.html data-toggle=tooltip data-placement=top title="Stephen Colletti and Alex Weaver Are Engaged After 1 Year of Dating">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=./tags/>FEATURED TAGS</a></h5><div class=tags></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"></ul><p class="copyright text-muted">Copyright &copy; RiffDash 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(i,t){var n=document,s="script",e=n.createElement(s),o=n.getElementsByTagName(s)[0];e.src=i,t&&e.addEventListener("load",function(e){t(null,e)},!1),o.parentNode.insertBefore(e,o)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(''),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("https://assets.cdnweb.info/hugo/cleanwhite/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/banner.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>